// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnvInfoWriterMW = void 0;
const teamsfx_api_1 = require("@microsoft/teamsfx-api");
const __1 = require("..");
const common_1 = require("../../common");
const constants_1 = require("../../plugins/solution/fx-solution/constants");
const environment_1 = require("../environment");
const projectSettingsLoader_1 = require("./projectSettingsLoader");
/**
 * This middleware will help to persist environment state even if lifecycle task throws Error.
 */
function EnvInfoWriterMW(skip = false) {
    return async (ctx, next) => {
        let error1 = undefined;
        try {
            await next();
        }
        catch (e) {
            if (e["name"] === common_1.getStrings().solution.CancelProvision)
                throw e;
            error1 = e;
        }
        let error2 = undefined;
        try {
            await writeEnvInfo(ctx, skip);
        }
        catch (e) {
            error2 = e;
        }
        if (error1)
            throw error1;
        if (error2)
            throw error2;
    };
}
exports.EnvInfoWriterMW = EnvInfoWriterMW;
async function writeEnvInfo(ctx, skip) {
    if (projectSettingsLoader_1.shouldIgnored(ctx) || skip) {
        return;
    }
    const lastArg = ctx.arguments[ctx.arguments.length - 1];
    const inputs = lastArg === ctx ? ctx.arguments[ctx.arguments.length - 2] : lastArg;
    if (!inputs.projectPath ||
        inputs.ignoreConfigPersist === true ||
        inputs.ignoreEnvInfo === true ||
        teamsfx_api_1.StaticPlatforms.includes(inputs.platform))
        return;
    const envInfoV2 = ctx.envInfoV2;
    if (!envInfoV2)
        return;
    const provisionOutputs = envInfoV2.state;
    if (provisionOutputs === undefined)
        return;
    // DO NOT persist local debug plugin config.
    if (provisionOutputs[constants_1.PluginNames.LDEBUG]) {
        delete provisionOutputs[constants_1.PluginNames.LDEBUG];
    }
    const envState = __1.flattenConfigJson(provisionOutputs);
    const envStatePath = await environment_1.environmentManager.writeEnvState(envState, inputs.projectPath, ctx.contextV2.cryptoProvider, envInfoV2.envName);
    if (envStatePath.isOk()) {
        __1.TOOLS.logProvider.debug(`[core] persist env state: ${envStatePath.value}`);
    }
}
//# sourceMappingURL=envInfoWriter.js.map